name: HyWater Infra Deployment

on:
  push:
    branches:
      - "main"

permissions:
  id-token: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22"
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  lint:
    name: Lint (lambdas)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: lambdas
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install dependencies (ci)
        run: npm ci --ignore-scripts
      - name: Run lint
        run: npm run lint

  build:
    name: Build (lambdas)
    runs-on: ubuntu-latest
    needs: [lint]
    defaults:
      run:
        working-directory: lambdas
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies (ci)
        run: npm ci --ignore-scripts

      - name: Rebuild esbuild (native)
        run: npm rebuild esbuild

      - name: Build
        run: npm run build

      - name: Upload lambda artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lambda-artifacts
          path: lambdas/artifacts/*.zip
          if-no-files-found: error

  push_staging:
    name: Push Artifacts (staging)
    runs-on: ubuntu-latest
    needs: [build]
    environment: staging
    env:
      LAMBDA_S3_BUCKET: ${{ vars.LAMBDA_STAGING_BUCKET_NAME }}
      ROLE_TO_ASSUME: arn:aws:iam::${{ vars.AWS_ACCOUNT_STAGING }}:role/hywater-portal-staging-github-actions-lambda-deployment
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          role-session-name: github-actions-staging-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download lambda artifacts
        uses: actions/download-artifact@v4
        with:
          name: lambda-artifacts
          path: lambdas/artifacts

      - name: Upload to S3
        env:
          COMMIT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(lambdas/artifacts/*.zip)
          if [ ${#files[@]} -eq 0 ]; then echo "No built lambda artifacts found." >&2; exit 1; fi
          for f in "${files[@]}"; do
            name=$(basename "${f}" .zip)
            local_sha=$(openssl dgst -sha256 -binary "${f}" | openssl base64)
            remote_sha=$(aws s3api head-object --bucket "${LAMBDA_S3_BUCKET}" --key "${name}.zip" --query 'Metadata.sha256' --output text)
            echo "Local sha256 (base64) for ${name}.zip: ${local_sha}"
            echo "Remote sha256 (base64) for ${name}.zip: ${remote_sha}"
            if [ "${local_sha}" = "${remote_sha}" ]; then
              echo "Skipping ${name}.zip (sha256 unchanged)"
              continue
            fi
            aws s3 cp "${f}" "s3://${LAMBDA_S3_BUCKET}/${name}.zip" \
              --metadata sha256=${local_sha},CommitSha=${COMMIT_SHA},BuildTime=$(date -u +%Y%m%dT%H%M%SZ) \
              --metadata-directive REPLACE
          done

  deploy_staging:
    name: Deploy (staging)
    runs-on: ubuntu-latest
    needs: [push_staging]
    environment: staging
    env:
      ROLE_TO_ASSUME: arn:aws:iam::${{ vars.AWS_ACCOUNT_STAGING }}:role/hywater-portal-staging-github-actions-lambda-deployment
      TF_WORKING_DIR: resources
      TF_VARS: ../env/staging/terraform.tfvars
      TF_BACKEND: ../env/staging/backend.hcl
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_STAGING }}:role/hywater-portal-staging-github-actions-infra-deployment
          role-session-name: github-actions-staging-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.6

      - name: Init, Plan, Apply (full)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          tofu init -input=false -backend-config=${{ env.TF_BACKEND }}
          tofu plan -input=false -var-file=${{ env.TF_VARS }} -out=tfplan
          tofu apply -auto-approve tfplan
