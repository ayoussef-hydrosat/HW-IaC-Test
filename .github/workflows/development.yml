name: Infra PR - Plan, Test, Analyze

on:
  pull_request:
    branches:
      - "**"

permissions:
  id-token: write
  contents: read
  pull-requests: write

concurrency:
  group: pr-infra-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  TOFU_VERSION: "1.11.0"
  PLAN_TEST_MODE_ENABLE: "false"
  PLAN_REFRESH: "false"

jobs:
  infra_check:
    name: Infra Check (${{ matrix.env }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - env: staging
            tf_dir: portal-staging
            role_to_assume: ${{ vars.AWS_PLAN_ROLE_STAGING_ARN }}
            policy_data: policy/data/staging.json

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Configure AWS Credentials (OIDC) - plan role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ matrix.role_to_assume }}
          role-session-name: pr-check-${{ matrix.env }}-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: tofu init
        working-directory: ${{ matrix.tf_dir }}
        run: tofu init -input=false

      - name: tofu fmt check
        working-directory: ${{ matrix.tf_dir }}
        run: tofu fmt -check -recursive

      - name: tofu validate
        working-directory: ${{ matrix.tf_dir }}
        run: tofu validate

  infra_plan:
    name: Infra Plan (${{ matrix.env }})
    runs-on: ubuntu-latest
    needs: [infra_check]
    strategy:
      fail-fast: false
      matrix:
        include:
          - env: staging
            tf_dir: portal-staging
            role_to_assume: ${{ vars.AWS_PLAN_ROLE_STAGING_ARN }}
            policy_data: policy/data/staging.json

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Configure AWS Credentials (OIDC) - plan role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ matrix.role_to_assume }}
          role-session-name: pr-plan-${{ matrix.env }}-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: tofu init
        working-directory: ${{ matrix.tf_dir }}
        run: tofu init -input=false

      - name: tofu plan
        working-directory: ${{ matrix.tf_dir }}
        run: |
          set -euo pipefail
          TF_VAR_is_test_mode_enabled=${{ env.PLAN_TEST_MODE_ENABLE }}           tofu plan -input=false -out=tfplan ${{ env.PLAN_REFRESH == 'false' && '-refresh=false' || '' }}

      - name: tofu show json
        working-directory: ${{ matrix.tf_dir }}
        run: tofu show -json tfplan > tfplan.json

      - name: Create plan summary markdown
        id: summary
        run: |
          set -euo pipefail
          f="${{ matrix.tf_dir }}/tfplan.json"
          adds=$(jq '[.resource_changes[]? | select(.change.actions | index("create"))] | length' "$f")
          changes=$(jq '[.resource_changes[]? | select(.change.actions | index("update"))] | length' "$f")
          destroys=$(jq '[.resource_changes[]? | select(.change.actions | index("delete"))] | length' "$f")

          {
            echo "## Plan Summary (${{ matrix.env }})"
            echo "Adds: ${adds}, Changes: ${changes}, Destroys: ${destroys}"
            echo ""
            echo "### Adds"
            jq -r '[.resource_changes[]? | select(.change.actions | index("create")) | .address] | if length == 0 then "  (none)" else .[] | "  - " + . end' "$f"
            echo ""
            echo "### Changes"
            jq -r '[.resource_changes[]? | select(.change.actions | index("update")) | .address] | if length == 0 then "  (none)" else .[] | "  - " + . end' "$f"
            echo ""
            echo "### Destroys"
            jq -r '[.resource_changes[]? | select(.change.actions | index("delete")) | .address] | if length == 0 then "  (none)" else .[] | "  - " + . end' "$f"
          } > /tmp/plan_summary_${{ matrix.env }}.md

      - name: Post sticky PR comment (plan summary)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: tofu-plan-${{ matrix.env }}
          path: /tmp/plan_summary_${{ matrix.env }}.md

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.env }}
          path: |
            ${{ matrix.tf_dir }}/tfplan
            ${{ matrix.tf_dir }}/tfplan.json
          if-no-files-found: error

  infra_test:
    name: Infra Test (${{ matrix.env }})
    runs-on: ubuntu-latest
    needs: [infra_plan]
    strategy:
      fail-fast: false
      matrix:
        include:
          - env: staging
            tf_dir: portal-staging
            role_to_assume: ${{ vars.AWS_PLAN_ROLE_STAGING_ARN }}
            policy_data: policy/data/staging.json

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Configure AWS Credentials (OIDC) - plan role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ matrix.role_to_assume }}
          role-session-name: pr-test-${{ matrix.env }}-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download plan artifacts
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ matrix.env }}
          path: ${{ matrix.tf_dir }}

      - name: Install Conftest
        run: |
          set -euo pipefail
          VERSION=0.57.0
          curl -sSL -o conftest.tar.gz "https://github.com/open-policy-agent/conftest/releases/download/v${VERSION}/conftest_${VERSION}_Linux_x86_64.tar.gz"
          tar -xzf conftest.tar.gz conftest
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Conftest policy checks
        run: |
          set -euo pipefail
          conftest verify -p policy --data "${{ matrix.policy_data }}" "${{ matrix.tf_dir }}/tfplan.json"

      - name: tofu init
        working-directory: ${{ matrix.tf_dir }}
        run: tofu init -input=false

      - name: tofu test
        working-directory: ${{ matrix.tf_dir }}
        run: |
          set -euo pipefail
          TF_VAR_is_test_mode_enabled=true           tofu test -test-directory=../tests

  infra_analysis:
    name: Infra Analysis (${{ matrix.env }})
    runs-on: ubuntu-latest
    needs: [infra_plan]
    strategy:
      fail-fast: false
      matrix:
        include:
          - env: staging
            tf_dir: portal-staging

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      # -------------------------
      # Generate baseline (main)
      # -------------------------
      - name: Checkout base branch
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

      - name: Infracost baseline (${{ matrix.env }})
        run: |
          infracost breakdown             --path ${{ matrix.tf_dir }}             --format json             --out-file /tmp/infracost-base.json

      # -------------------------
      # Generate PR cost
      # -------------------------
      - name: Checkout PR branch again
        run: |
          git checkout -

      - name: Infracost current (${{ matrix.env }})
        run: |
          infracost breakdown             --path ${{ matrix.tf_dir }}             --format json             --out-file /tmp/infracost-current.json

      - name: Infracost diff (${{ matrix.env }})
        run: |
          infracost diff             --path ${{ matrix.tf_dir }}             --compare-to /tmp/infracost-base.json             --format json             --out-file /tmp/infracost.json

      - name: Build Infracost PR comment
        run: |
          infracost diff             --path ${{ matrix.tf_dir }}             --compare-to /tmp/infracost-base.json             --format diff             --out-file /tmp/infracost.raw.md
          baseline_total=$(jq -r '(.total_monthly_cost // .totalMonthlyCost // empty) | tostring' /tmp/infracost-base.json)
          current_total=$(jq -r '(.total_monthly_cost // .totalMonthlyCost // empty) | tostring' /tmp/infracost-current.json)
          cost_diff=$(jq -r '(.diff.total_monthly_cost.change // .diff.totalMonthlyCost.change // .diff.total_monthly_cost.delta // .diff.totalMonthlyCost.delta // empty) | tostring' /tmp/infracost.json)
          {
            echo "## Infra Cost Analysis"
            echo ""
            if [ -n "$baseline_total" ] && [ "$baseline_total" != "null" ]; then echo "Baseline total (monthly): $baseline_total"; else echo "Baseline total (monthly): n/a"; fi
            if [ -n "$current_total" ] && [ "$current_total" != "null" ]; then echo "Current total (monthly): $current_total"; else echo "Current total (monthly): n/a"; fi
            if [ -n "$cost_diff" ] && [ "$cost_diff" != "null" ]; then echo "Cost diff (monthly): $cost_diff"; else echo "Cost diff (monthly): 0"; fi
            echo ""
            cat /tmp/infracost.raw.md
          } > /tmp/infracost.md

      # -------------------------
      # Post PR comment
      # -------------------------
      - name: Post Infracost comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: infracost-${{ matrix.env }}
          path: /tmp/infracost.md
