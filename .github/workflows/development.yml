name: Infra PR

on:
  pull_request:
    branches:
      - "**"

permissions:
  id-token: write
  contents: read
  pull-requests: write

concurrency:
  group: pr-infra-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  TOFU_VERSION: "1.11.0"
  PLAN_TEST_MODE_ENABLE: "false"
  PLAN_REFRESH: "false"

jobs:
  # Basic linting & validation only. Produces no artifacts.  
  infra_check:
    name: Infra Check (${{ matrix.env }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - env: staging
            tf_dir: resources
            role_to_assume: ${{ vars.AWS_PLAN_ROLE_STAGING_ARN }}
            policy_data: policy/data/staging.json
            tf_vars: env/staging/terraform.tfvars
            tf_backend: env/staging/backend.hcl

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Configure AWS Credentials (OIDC) - plan role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ matrix.role_to_assume }}
          role-session-name: pr-check-${{ matrix.env }}-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: tofu init
        working-directory: ${{ matrix.tf_dir }}
        run: tofu init -input=false -reconfigure -backend-config=../${{ matrix.tf_backend }}

      - name: tofu fmt check
        run: tofu fmt -check -recursive resources

      - name: tofu validate
        working-directory: ${{ matrix.tf_dir }}
        run: tofu validate

  # Generate plan + PR summary and upload tfplan artifacts.      
  infra_plan:
    name: Infra Plan (${{ matrix.env }})
    runs-on: ubuntu-latest
    needs: [infra_check]
    strategy:
      fail-fast: false
      matrix:
        include:
          - env: staging
            tf_dir: resources
            role_to_assume: ${{ vars.AWS_PLAN_ROLE_STAGING_ARN }}
            policy_data: policy/data/staging.json
            tf_vars: env/staging/terraform.tfvars
            tf_backend: env/staging/backend.hcl

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Configure AWS Credentials (OIDC) - plan role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ matrix.role_to_assume }}
          role-session-name: pr-plan-${{ matrix.env }}-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: tofu init
        working-directory: ${{ matrix.tf_dir }}
        run: tofu init -input=false -reconfigure -backend-config=../${{ matrix.tf_backend }}

      - name: tofu plan
        working-directory: ${{ matrix.tf_dir }}
        run: |
          set -euo pipefail
          TF_VAR_is_test_mode_enabled=${{ env.PLAN_TEST_MODE_ENABLE }}           tofu plan -input=false -var-file=../${{ matrix.tf_vars }} -out=tfplan ${{ env.PLAN_REFRESH == 'false' && '-refresh=false' || '' }}

      - name: tofu show json
        working-directory: ${{ matrix.tf_dir }}
        run: tofu show -json tfplan > tfplan.json

      - name: Create plan summary markdown
        id: summary
        run: |
          set -euo pipefail
          f="${{ matrix.tf_dir }}/tfplan.json"
          adds=$(jq '[.resource_changes[]? | select(.change.actions | index("create"))] | length' "$f")
          changes=$(jq '[.resource_changes[]? | select(.change.actions | index("update"))] | length' "$f")
          destroys=$(jq '[.resource_changes[]? | select(.change.actions | index("delete"))] | length' "$f")
          replaces=$(jq '[.resource_changes[]? | select(.change.actions | index("delete")) | select(.change.actions | index("create"))] | length' "$f")

          {
            echo "## Plan Summary (${{ matrix.env }})"
            echo "Adds: ${adds}, Changes: ${changes}, Destroys: ${destroys}, Replaces: ${replaces}"
            echo ""
            echo "### Adds"
            jq -r '[.resource_changes[]? | select(.change.actions | index("create")) | ("  - " + .type + " (" + .address + ")")] | if length == 0 then "  (none)" else .[] end' "$f"
            echo ""
            echo "### Changes"
            jq -r '
              def changed_keys(before; after):
                (before // {} | keys_unsorted) as $b
                | (after // {} | keys_unsorted) as $a
                | ($b + $a | unique) as $keys
                | [ $keys[] | select((before[.] != after[.])) ];
              [ .resource_changes[]?
                | select(.change.actions | index("update"))
                | . as $rc
                | (changed_keys($rc.change.before; $rc.change.after)) as $keys
                | "  - " + $rc.address + (if ($keys|length) > 0 then " (change: " + ($keys|join(", ")) + ")" else " (change: unknown)" end)
              ]
              | if length == 0 then "  (none)" else .[] end
            ' "$f"
            echo ""
            echo "### Destroys"
            jq -r '[.resource_changes[]? | select(.change.actions | index("delete")) | .address] | if length == 0 then "  (none)" else .[] | "  - " + . end' "$f"
          } > /tmp/plan_summary_${{ matrix.env }}.md

      - name: Post sticky PR comment (plan summary)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: tofu-plan-${{ matrix.env }}
          path: /tmp/plan_summary_${{ matrix.env }}.md

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.env }}
          path: |
            ${{ matrix.tf_dir }}/tfplan
            ${{ matrix.tf_dir }}/tfplan.json
          if-no-files-found: error

  infra_test:
    name: Infra Test (${{ matrix.env }})
    runs-on: ubuntu-latest
    needs: [infra_plan]
    strategy:
      fail-fast: false
      matrix:
        include:
          - env: staging
            tf_dir: resources
            role_to_assume: ${{ vars.AWS_PLAN_ROLE_STAGING_ARN }}
            policy_data: policy/data/staging.json
            tf_vars: env/staging/terraform.tfvars
            tf_backend: env/staging/backend.hcl

    # Use plan artifacts for Conftest policies, then run tofu tests in test mode.
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Configure AWS Credentials (OIDC) - plan role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ matrix.role_to_assume }}
          role-session-name: pr-test-${{ matrix.env }}-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download plan artifacts
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ matrix.env }}
          path: ${{ matrix.tf_dir }}

      - name: Install Conftest
        run: |
          set -euo pipefail
          VERSION=0.57.0
          curl -sSL -o conftest.tar.gz "https://github.com/open-policy-agent/conftest/releases/download/v${VERSION}/conftest_${VERSION}_Linux_x86_64.tar.gz"
          tar -xzf conftest.tar.gz conftest
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Conftest policy checks
        run: |
          set -euo pipefail
          conftest verify -p policy --data "${{ matrix.policy_data }}" "${{ matrix.tf_dir }}/tfplan.json"

      - name: tofu init
        working-directory: ${{ matrix.tf_dir }}
        run: tofu init -input=false -reconfigure -backend-config=../${{ matrix.tf_backend }}

      - name: tofu test
        working-directory: ${{ matrix.tf_dir }}
        run: |
          set -euo pipefail
          # Test mode disables resources that require apply-time values.
          TF_VAR_is_test_mode_enabled=true           tofu test -test-directory=../tests -var-file=../${{ matrix.tf_vars }}

  infra_analysis:
    name: Infra Analysis (${{ matrix.env }})
    runs-on: ubuntu-latest
    needs: [infra_plan]
    strategy:
      fail-fast: false
      matrix:
        include:
          - env: staging
            tf_dir: resources
            tf_vars: env/staging/terraform.tfvars
          - env: production
            tf_dir: resources
            tf_vars: env/production/terraform.tfvars

    # Compare base costs vs PR costs and post an env-specific Infracost comment.
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Checkout base branch
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}

      - name: Infracost baseline (${{ matrix.env }})
        run: |
          infracost breakdown \
            --path ${{ matrix.tf_dir }} \
            --terraform-var-file ${{ matrix.tf_vars }} \
            --terraform-var is_test_mode_enabled=false \
            --format json \
            --out-file /tmp/infracost-base.json
          infracost breakdown \
            --path ${{ matrix.tf_dir }} \
            --terraform-var-file ${{ matrix.tf_vars }} \
            --terraform-var is_test_mode_enabled=false \
            --show-skipped \
            --format table \
            --out-file /tmp/infracost-base-skipped.txt

      - name: Checkout PR branch again
        run: |
          git checkout -

      - name: Infracost current (${{ matrix.env }})
        run: |
          infracost breakdown \
            --path ${{ matrix.tf_dir }} \
            --terraform-var-file ${{ matrix.tf_vars }} \
            --terraform-var is_test_mode_enabled=false \
            --format json \
            --out-file /tmp/infracost-current.json
          infracost breakdown \
            --path ${{ matrix.tf_dir }} \
            --terraform-var-file ${{ matrix.tf_vars }} \
            --terraform-var is_test_mode_enabled=false \
            --show-skipped \
            --format table \
            --out-file /tmp/infracost-current-skipped.txt

      - name: Infracost diff (${{ matrix.env }})
        run: |
          infracost diff \
            --path ${{ matrix.tf_dir }} \
            --compare-to /tmp/infracost-base.json \
            --terraform-var-file ${{ matrix.tf_vars }} \
            --terraform-var is_test_mode_enabled=false \
            --format json \
            --out-file /tmp/infracost.json
          infracost diff \
            --path ${{ matrix.tf_dir }} \
            --compare-to /tmp/infracost-base.json \
            --terraform-var-file ${{ matrix.tf_vars }} \
            --terraform-var is_test_mode_enabled=false \
            --show-skipped \
            --format table \
            --out-file /tmp/infracost-diff-skipped.txt

      - name: Build Infracost PR comment
        run: |
          baseline_total=$(jq -r '
            def to_num:
              if type=="string" then (gsub("\\$"; "") | tonumber? // 0)
              elif type=="number" then .
              else 0 end;
            [ .projects[]? | (.total_monthly_cost // .totalMonthlyCost // 0) | to_num ] | add
          ' /tmp/infracost-base.json)
          current_total=$(jq -r '
            def to_num:
              if type=="string" then (gsub("\\$"; "") | tonumber? // 0)
              elif type=="number" then .
              else 0 end;
            [ .projects[]? | (.total_monthly_cost // .totalMonthlyCost // 0) | to_num ] | add
          ' /tmp/infracost-current.json)
          cost_diff=$(jq -r '
            def to_num:
              if type=="string" then (gsub("\\$"; "") | tonumber? // 0)
              elif type=="number" then .
              else 0 end;
            def diff_total:
              (.diff.total_monthly_cost.change // .diff.totalMonthlyCost.change // .diff.total_monthly_cost.delta // .diff.totalMonthlyCost.delta // empty) as $d
              | if ($d == null) or ($d == "") then
                  ([ .projects[]? | (.diff.total_monthly_cost.change // .diff.totalMonthlyCost.change // .diff.total_monthly_cost.delta // .diff.totalMonthlyCost.delta // 0) | to_num ] | add)
                else ($d | to_num) end;
            diff_total
          ' /tmp/infracost.json)
          {
            echo "## Infra Cost Analysis (${{ matrix.env }})"
            echo ""
            if [ -n "$baseline_total" ] && [ "$baseline_total" != "null" ]; then echo "Baseline total (monthly): $baseline_total"; else echo "Baseline total (monthly): n/a"; fi
            if [ -n "$current_total" ] && [ "$current_total" != "null" ]; then echo "Current total (monthly): $current_total"; else echo "Current total (monthly): n/a"; fi
            if [ -n "$cost_diff" ] && [ "$cost_diff" != "null" ]; then echo "Cost diff (monthly): $cost_diff"; else echo "Cost diff (monthly): 0"; fi
            echo ""
            echo "### Infracost details (show-skipped)"
            echo "#### Baseline"
            echo "```"
            cat /tmp/infracost-base-skipped.txt
            echo "```"
            echo "#### Current"
            echo "```"
            cat /tmp/infracost-current-skipped.txt
            echo "```"
            echo "#### Diff"
            echo "```"
            cat /tmp/infracost-diff-skipped.txt
            echo "```"
          } > /tmp/infracost.md

      - name: Post Infracost comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: infracost-${{ matrix.env }}
          path: /tmp/infracost.md
